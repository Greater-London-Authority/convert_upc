---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

```{r,  include = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```


```{r, include = FALSE}
source("R/functions/optimise_gross_flows.R")
source("R/functions/split_gross_flows.R")
```

```{r, include = FALSE}
sel_code <- "E09000007"
sel_sex <- "female"
sel_components <- c("international_in", "international_out", "international_net", "unattrib")

mye_comp <- bind_rows(
  readRDS("data/intermediate/mye_2011_on(2023_geog).rds") %>%
    mutate(source = "original"),
  readRDS("data/processed/new_mye_series_2011_on.rds") %>%
    mutate(source = "adjusted")) %>%
  filter(gss_code == sel_code,
         sex == sel_sex,
         component %in% sel_components) %>%
  mutate(value = case_when(
    component == "international_out" ~ -value,
    TRUE ~ value
  ))

mye_comp_totals <- mye_comp %>%
  group_by(across(-any_of(c("value", "age")))) %>%
  summarise(value = sum(value), .groups = "drop") %>%
  arrange(year) %>%
  group_by(across(-any_of(c("value", "year")))) %>%
  mutate(cumulative_value = cumsum(value)) %>%
  ungroup()

```

```{r, include = FALSE}
sel_code <- "E08000035"
sel_sex <- "female"
sel_components <- c("international_in", "international_out", "international_net",
                    "unattrib", "total_net", 
                    "internal_in", "internal_out", "internal_net")

dpm_comp <- bind_rows(
  readRDS("data/intermediate/mye_2011_on(2023_geog).rds") %>%
    mutate(source = "MYE original"),
  readRDS("data/processed/new_mye_series_2011_on.rds") %>%
    mutate(source = "MYE adjusted"),
  readRDS("data/processed/new_dpm_series_2011_on.rds") %>%
    mutate(source = "DPM")) %>%
  filter(gss_code == sel_code,
         sex == sel_sex,
         component %in% sel_components) %>%
  mutate(value = case_when(
    component == "international_out" ~ -value,
    component == "internal_out" ~ -value,
    component == "total_out" ~ -value,
    TRUE ~ value
  ))

dpm_comp_totals <- dpm_comp %>%
  group_by(across(-any_of(c("value", "age")))) %>%
  summarise(value = sum(value), .groups = "drop") %>%
  arrange(year) %>%
  group_by(across(-any_of(c("value", "year")))) %>%
  mutate(cumulative_value = cumsum(value)) %>%
  ungroup()

```


# convert_upc

This repository contains two related examples of:
* how the Unattributable Population Change (UPC) component included in the rebased ONS mid-year estimate (MYE) population back series could be replaced with adjustments to the existing annual international migration estimates.
* how total in- and out-flows in ONS's current Admin-Based Population Estimates (ABPE)/Dynamic Population Model (DPM) estimates could be split into separate international and domestic flows.

## Converting UPC in the rebased MYE series

The method shown here uses a single function that takes an initial pair gross flows, together with a target net value, and returns new gross flows that are consistent with this net figure and represent the minimum 'cost' change to the original flows. 

This function was originally developed by the GLA in its process for creating the [rebased population estimates](https://data.london.gov.uk/dataset/modelled-population-backseries) used as a basis for the GLA's population projections.  

The full GLA rebasing process is complex and involves fitting new annual net flows before splitting these out into gross flows and building a consistent annual population series. 

However, if the goal is just to reassign already calculated UPC to international flows, without modifying the estimated population, then the process is greatly simplified.

## Splitting ABPE total flows

This method repurposes the function used for modifying a pair of base in- and out-flows to fit a target net flow such that it instead modifies a pair of flows with the same direction to fit a total figure, while accounting for the user's relative confidence in the accuracy of the base international and domestic flow estimates.

Here the base domestic and international flows are taken from the ONS rebased MYE series and used to split the total flow components in the published ABPE/DPM series.

Confidence in the accuracy of flow estimates will vary by area, age, sex, direction, and year.  In this example, an arbitrary value of 0.98 has been used for the confidence parameter in all cases - with values below 1 implying lower confidence in the accuracy of the original estimates of international migration than of domestic. 

## Instructions

The two processes are run from the scripts *R/run_process_ons2023_mye_series.R* and *R/run_process_ons_dpm_series.R*, respectively.

*R/run_process_ons2023_mye_series.R* will:

* Fetch and clean the detailed mid-year estimates series published by ONS that covers the period 2011 to 2023 
* Create modelled alternative annual international gross flows that are consistent with the sum of the international_net and UPC components
* Write out the new series to *data/processed/* as both an RDS file in tidy format and as a csv in a similar format to that originally published by ONS

*R/run_process_ons_dpm_series.R* will:
* Fetch and clean the detailed mid-year estimates series published by ONS that covers the period 2011 to 2023 
* Fetch and clean the current admin-based estimates series published July 2024, which also covers the period 2011 to 2023 * Create modelled annual international and internal flow components that are consistent with the original total immigration and emigration components
* Write out the new series to *data/processed/* as both an RDS file in tidy format and as a csv in a similar format to that originally published by ONS

### Required packages

dplyr, tidyr, readxl, readr, stringr


# Overview of methodologies

## Converting UPC in the rebased MYE series

In population modelling, it is often the case that we wish to make an adjustment to the size of a population stock or net migration flow and must make corresponding adjustment to the size of the underlying gross flows, such that they remain consistent. When the adjustment to the net flow is positive, consistent gross flows can be created by some combination of higher inflows and/or lower outflows (and vice versa). As a given net flow can be described by any number of different pairs of in- and out-flows, the problem is to choose the most appropriate values for the in- and outflows.

The approach taken by the GLA to this problem is to try and identify adjustments that minimise (from a statistical perspective) changes from the original gross flow estimates.  

* Gross flows are treated as having an underlying probability density described by a Poission distribution with means equal to the original estimates. 

* Starting from the initial values of the gross flows, an incremental adjustment is made to either the inflow or outflow according to which would see the smaller decrease in the probability density after the adjustment is made.  

* Successive incremental adjustments are made until the gross flows are consistent with desired net flow.

The relative size of the adjustments to the in- and out-flows is determined by the sizes of the initial flows and the size and direction of the adjustment required.  In cases where the initial gross flows are already consistent with the target net, the function will return these values unchanged. 

The example below illustrates how the modelled gross flows for a given pair of base flows vary with the target net figure.

```{r, echo = FALSE}

example_df <- data.frame(target_net = c(-100:100), base_in = 40, base_out = 15) %>%
  mutate(model_flows = optimise_gross_flows(base_in, base_out, target_net)) %>%
  unnest_wider(col = model_flows) %>%
  mutate(outflow = -outflow) %>%
  pivot_longer(cols = c("inflow", "outflow"), names_to = "direction", values_to = "gross_flows")

example_df %>%
  ggplot(aes(x = target_net, y = gross_flows, colour = direction)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_hline(yintercept = c(40, -15), linetype = "dotted") +
  geom_vline(xintercept = 25, linetype = "dotted") +
  geom_line(linewidth = 1, alpha = 0.7) +
  labs(title = "Returned gross flow values by net flow target",
       subtitle = "base inflow = 40, base outflow = 15, original net = +25")


```

In this application the target international net flow is taken to be the sum of the values of the original international net flow and the UPC component.

The following charts illustrate the original and adjusted data for females in Camden - a group with a very high UPC component in the rebased estimates which removes almost 18 thousand persons from the population over the course of the decade.   


```{r, echo = FALSE}

mye_comp_totals %>%
  filter(component %in% c("international_net", "unattrib")) %>%
  filter(between(year, 2011, 2021)) %>%
  ggplot(aes(x = year, y = value, colour = component, linetype = source)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_line(linewidth = 1, alpha = 0.4) +
  labs(title = "Original and adjusted annual international net and UPC",
       subtitle = "Camden, female") +
    scale_x_continuous(n.breaks = 9)

```

```{r, echo = FALSE}

mye_comp_totals %>%
  filter(component %in% c("international_net", "unattrib")) %>%
  filter(between(year, 2011, 2021)) %>%
  ggplot(aes(x = year, y = cumulative_value, colour = source, linetype = component)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_line(linewidth = 1, alpha = 0.4) +
  labs(title = "Cummulative contribution of international net and UPC",
       subtitle = "Camden, female") +
    scale_x_continuous(n.breaks = 9)

```

```{r, echo = FALSE}

mye_comp %>%
  filter(year == 2019) %>%
  filter(component %in% c("international_net", "unattrib")) %>%
  ggplot(aes(x = age, y = value, colour = source, linetype = component)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_line(alpha = 0.7) +
  labs(title = "Original and adjusted international net and UPC",
       subtitle = "Camden, female, 2019") + 
  scale_x_continuous(n.breaks = 9) +
  facet_wrap("source")

```

```{r, echo = FALSE}

mye_comp %>%
  filter(year == 2019) %>%
  filter(between(age, 19, 29)) %>%
  filter(component %in% c("international_net", "unattrib")) %>%
  ggplot(aes(x = age, y = value, colour = source, linetype = component)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_point(size = 3, alpha = 0.7) +
  geom_line(linewidth = 1, alpha = 0.4) + 
  labs(title = "Original and adjusted international net and UPC",
       subtitle = "Camden, female, 2019; selected ages") + 
  scale_x_continuous(n.breaks = 9)

```
As intended, the adjusted gross flows closely track the distributions of the original estimates by year and by age.

```{r, echo = FALSE}

mye_comp_totals %>%
  filter(component %in% c("international_in", "international_out")) %>%
  filter(between(year, 2011, 2021)) %>%
  ggplot(aes(x = year, y = value, colour = component, linetype = source)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_line(linewidth = 1, alpha = 0.4) +
  labs(title = "Original and adjusted annual international gross flows",
       subtitle = "Camden, female",
       caption = "Outflows shown as negative values") +
    scale_x_continuous(n.breaks = 9)

```

```{r, echo = FALSE}

mye_comp %>%
  filter(year == 2019) %>%
  filter(component %in% c("international_in", "international_out")) %>%
  ggplot(aes(x = age, y = value, colour = component, linetype = source)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_line(alpha = 0.7) +
  labs(title = "Original and adjusted international gross flows by age",
       subtitle = "Camden, female, 2019",
       caption = "Outflows shown as negative values") +
    scale_x_continuous(n.breaks = 9)

```

```{r, echo = FALSE}

mye_comp %>%
  filter(year == 2019) %>%
  filter(between(age, 19, 29)) %>%
  filter(component %in% c("international_in", "international_out")) %>%
  ggplot(aes(x = age, y = value, colour = component, linetype = source)) +
  theme_minimal() +
  geom_hline(yintercept = 0, colour = "grey") +
  geom_point(size = 3, alpha = 0.7) +
  geom_line(linewidth = 1, alpha = 0.4) + 
  scale_x_continuous(n.breaks = 9) +  
  labs(title = "Original and adjusted international gross flows by age",
       subtitle = "Camden, female, 2019; selected ages",
       caption = "Outflows shown as negative values") 

```

## Splitting total gross flows from DPM

```{r, echo = FALSE}

example_df <- expand.grid(target_total = c(0:400), relative_international_confidence = c(0.97, 0.98, 0.99, 1), 
                         base_international = 50, base_domestic = 100) %>%
  mutate(model_flows = split_gross_flows(base_international, base_domestic, target_total,
                                         relative_international_confidence,
                                         jump_scale = 30)) %>%
  unnest_wider(col = model_flows) %>%
  select(-c(base_international, base_domestic)) %>%
  pivot_longer(cols = c("new_international", "new_domestic"), names_to = "flow", values_to = "value")

example_df %>%
  ggplot(aes(x = target_total, y = value, colour = flow)) +
  theme_minimal() +
  geom_hline(yintercept = c(50, 100), linetype = "dotted") +
  geom_vline(xintercept = 150, linetype = "dotted") +
  geom_line(linewidth = 1, alpha = 0.7) +
  labs(title = "Returned flows by total target and relative confidence",
       subtitle = "base international = 50, base domestic = 100, original total flow = 150") +
  facet_wrap("relative_international_confidence", ncol = 2)


```
